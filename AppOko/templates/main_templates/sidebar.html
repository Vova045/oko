{% load static %}

{% block custom_css %}
<link rel="stylesheet" href="{% static '/css/sidebar.css' %}">
{% endblock custom_css %}
<div class="closed_sidebar">
  <div class="nav_icon_div" onclick="openNav()">
      <img class="nav_icon_div_img" src="{% static 'svg/nav_icon.svg' %}">
  </div>
</div>
<div id="mySidebar" class="sidebar">
    <div class="main_part">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <!-- <a href="#">Войти</a>
      <a href="#">Регистрация</a> -->
        <div class="login_div" id="login_id">
          {% if not request.user.username or request.user.user_type == "4" %}
          <div class="card card-danger" id="signin_div">
            <div class="card-header"><h4>Вход</h4></div>
  
            <div class="card-body">
              <form method="POST" action="{% url 'admin_login_process' %}" class="needs-validation" novalidate="">
                {% csrf_token %}
                <div class="form-group">
                  <label for="email">Логин</label>
                  <input id="email" type="text" class="form-control login_form" name="username" tabindex="1" required autofocus>
                  <div class="invalid-feedback">
                    Пожалуйста Введите ваш логин
                  </div>
                </div>
  
                <div class="form-group">
                  <div class="d-block">
                    <label for="password" class="control-label">Пароль</label>
                  </div>
                  <input id="password" type="password" class="form-control login_form" name="password" tabindex="2" required>
                  <div class="invalid-feedback">
                    Пожалуйста введите ваш пароль
                  </div>
                </div>
  
                <!-- <div class="form-group">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" name="remember" class="custom-control-input" tabindex="3" id="remember-me">
                    <label class="custom-control-label" for="remember-me">Запомнить</label>
                  </div>
                </div> -->
                {% if messages %}
                <div class="form-group">
                  {% for message in messages %}
                  {% if message.tags == "error" %}
                  <div class="alert alert-danger">
                    {{ message }}
                  </div>
                  {% endif %}
                  {% if message.tags == "success" %}
                  <div class="alert alert-success">
                    {{ message }}
                  </div>
                  {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
                <div class="form-group">
                  <button type="submit" class="btn btn-danger btn-lg btn-block" style="background-color:#FF2E00" tabindex="4">
                    Войти
                  </button>
                </div>
                <p style="cursor: pointer;" id="registration_button" onclick="openReg()">Регистрация</p>
              </form>
  
            </div>
          </div>
          <div class="card card-danger" id="registration_div">
            <div class="card-header"><h4>Регистрация</h4></div>
  
            <div class="card-body">
              <form method="POST" action="{% url 'admin_registration_process' %}" class="needs-validation" novalidate="">
                {% csrf_token %}
                <div class="form-group">
                  <label for="email">Логин</label>
                  <input id="email" type="text" class="form-control registration_form" name="username" tabindex="1" required autofocus>
                  <div class="invalid-feedback">
                    Пожалуйста Введите ваш логин
                  </div>
                </div>
  
                <div class="form-group">
                  <div class="d-block">
                    <label for="password" class="control-label">Пароль</label>
                  </div>
                  <input id="password" type="password" class="form-control registration_form" name="password" tabindex="2" required>
                  <div class="invalid-feedback">
                    Пожалуйста введите ваш пароль
                  </div>
                </div>
  
                <div class="form-group">
                  <div class="d-block">
                    <label for="password2" class="control-label">Повторите Пароль</label>
                  </div>
                  <input id="password2" type="password" class="form-control registration_form" name="password2" tabindex="2" required>
                  <div class="invalid-feedback">
                    Пожалуйста повторите ваш пароль
                  </div>
                </div>
  
                <!-- <div class="form-group">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" name="remember" class="custom-control-input" tabindex="3" id="remember-me">
                  </div>
                </div> -->
                <div class="form-group">
                  <button type="submit" class="btn btn-danger btn-lg btn-block" style="background-color:#FF2E00" tabindex="4">
                    Зарегистрироваться
                  </button>
                </div>
                <p style="cursor: pointer;" id="registration_form_button" onclick="openSignIn()">Войти</p>
              </form>
  
            </div>
          </div>
          {% endif %}
          {% if not request.user.username or request.user.user_type == "1" %}
          <div class="sidebar_item">
            <div class="sidebar_item_hr"></div>
            <p id="corporation_chat">Корпоративный чат</p>
          </div>
          {% endif %}
          <div class="simple-footer">
            {% if request.user.username %}
            <p>Здравствуйте, {{ request.user.username }} <br>
            <a href="{% url 'admin_logout_process' %}">Выйти</a></p>
            {% endif %}
            Copyright &copy; OKO 2022 
          </div>
        </div>
    </div>
    <div class="second_part">
      <div class="white_line">
      </div>
      <div class="info">
        <div class="chat_head">
          <p id="chat_head_id">Чат с нашим менеджером</p>
        </div>
        <div class="chat_body" id="chat_body">
          <!-- <div class="message_item message_manager">
            <div class="message_head">
              <p>Менеджер Елена</p>
              <p>22.02.2023 00:09</p>
            </div>
            <div class="message_body">
              <p>Здравствуйте, что Вас интересует?</p>
            </div>
          </div> -->
          <!-- <div class="message_item message_client">
            <div class="message_head">
              <p>Вы</p>
              <p>22.02.2023 00:11</p>
            </div>
            <div class="message_body">
              <p>Световые буквы</p>
            </div>
          </div> -->
          {% for message in room_messages %}
          <div class="message_item {% if message.user.user_type == '1' %} message_manager {% elif message.user.user_type == '3' %} message_client {% endif %}">
            <div class="message_head">
              <input class="id_message" style="display: none;" value="{{ message.id }}"></input>
              <p>{{ message.user }}</p>
              <p>{{ message.created }}</p>
            </div>
            <div class="message_body" id="message_body">
              <p>{{ message.body }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="input_field">
            <div class="skrepka">
              <img src="{% static 'svg/skrepka.svg' %}">
              <input type="file" name="media_content[]" class="form-control select_media" />
            </div>
            <input type="text" id="chat_message_input" placeholder="Введите ваше сообщение" form="input_chat_message" name="body" class="chat_input"/>
            <button type="text" id="chat_message_submit" style="display: none;"></button>
        </div>
        <div class="preview_media">

        </div>
      </div>
    </div>
</div>
{% block custom_js %}
<script src="{% static '/modules/jquery.min.js' %}"></script>
<script>
  document.getElementById('chat_body').scrollTo(0, document.getElementById('chat_body').scrollHeight);

  document.querySelector('#corporation_chat').onclick = function(){
    document.getElementById("mySidebar").style.width = "fit-content";
    if(document.querySelector('.second_part').style.display == 'flex'){
      document.querySelector('.second_part').style.display = "none";
    }
    else {
      document.querySelector('.second_part').style.display = "flex";
    }
  }

  document.querySelector('.skrepka').onclick = function(){
    document.querySelector('.select_media').click();
    }
    /* Set the width of the sidebar to 250px and the left margin of the page content to 250px */
function openNav() {
  if (document.getElementById("mySidebar").style.width == "fit-content" || document.getElementById("mySidebar").style.width == "300px")
  {
  document.getElementById("login_id").style.display = "none";
  document.getElementById("mySidebar").style.width = "0";
  }
  else {
    document.querySelector('.second_part').style.display = "none";
    document.getElementById("mySidebar").style.width = "300px";
    setTimeout(() => {document.getElementById("login_id").style.display = "flex";}, 150);
    
  }
}
function openReg() {
  document.getElementById("signin_div").style.display = "none";
  document.getElementById("registration_div").style.display = "flex";
}
function openSignIn() {
  document.getElementById("signin_div").style.display = "flex";
  document.getElementById("registration_div").style.display = "none";
}

/* Set the width of the sidebar to 0 and the left margin of the page content to 0 */
function closeNav() {
  document.getElementById("mySidebar").style.width = "0";
}
</script>

<script>
  document.querySelector('#chat_message_input').focus();
  document.querySelector('#chat_message_input').onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter, return
        document.querySelector('#chat_message_submit').click();
        document.querySelector('#chat_message_input').value = '';
      }
  };
  function getdata_chatmessage() {
    var body = document.querySelector('#chat_message_input').value
    var room_id = '{{ room.id }}'
    var user_id = '{{ request.user.id }}'
    var host_id = ''
      
    $.ajax({
        url: '/admindashboard/chatmessage_send',
        data : {
          'body' : body,
          'room_id' : room_id,
          'user_id' : user_id,
          'host_id' : host_id,
        },
        method : 'GET',
        async : false,
        success : function(result){
          if (result !== ""){
            console.log(result[0].user_id)
          console.log(result[0].body)
          console.log(result[0].room_id)
          console.log(result[0].created)
          console.log(result[0].updated)
          console.log(result[0].user_type)
          if (result[0].user_type.toString() == '1') {
            result[0].user_type = 'message_manager';
          } else if (result[0].user_type.toString() == '3') {
            result[0].user_type = 'message_client';
          }

          $('#chat_body').append(
          '<div class="message_item ' + result[0].user_type +'">'
          + '<div class="message_head"><p>' + result[0].user_id  +  '</p><p>'+ result[0].created +'</p></div>' + 
          '<div class="message_body" id="message_body">' +
              '<p>' + result[0].body + '</p></div></div>'
          );
          var objDiv = document.getElementById("chat_body");
          objDiv.scrollTop = objDiv.scrollHeight;
          }
          
        }

      });
    }
  function getdata_checkmessage() {
    // console.log("чек")
    // var id_messages = document.querySelectorAll(".id_message")
    // var id_messages_list = [];
    //   for (var i = 0; i < id_messages.length; i++) {
    //       if (id_messages[i].value) {
    //         id_messages_list.push(id_messages[i].value);
    //       }
    //   }
    // console.log(id_messages_list)
    var room_id = '{{ room.id }}'
    var user_id = '{{ request.user.id }}'
    var host_id = ''
    $.ajax({
        url: '/admindashboard/chatmessage_check',
        data : {
          'room_id' : room_id,
          'user_id' : user_id,
          'host_id' : host_id
          // 'id_messages_list' : id_messages_list,  
        },
        method : 'GET',
        async : false,
        success : function(result){
          if (result !== ""){
            for (var i = result.length - 1; i >= 0; i--) {
              if (result[i].toString() == '1') {
              result[i].user_type = 'message_manager';
              } else if (result[i].user_type.toString() == '3') {
                result[i].user_type = 'message_client';
              }

              $('#chat_body').append(
              '<div class="message_item ' + result[i].user_type +'">'
              + '<div class="message_head"><p>' + result[i].username  +  '</p><p>'+ result[i].created +'</p></div>' + 
              '<div class="message_body" id="message_body">' +
                  '<p>' + result[i].body + '</p></div></div>'
              );
              console.log('Сообщение появилось')
              var objDiv = document.getElementById("chat_body");
              objDiv.scrollTop = objDiv.scrollHeight;
              };
          }
          
        }
      });
    }
  $(document).ready(function(){
    document.querySelector('#chat_message_submit').onclick = function(){
      getdata_chatmessage()
    }
  });
  // window.setInterval(getdata_checkmessage, 3000);
  
</script>
{% endblock custom_js %}